os: linux
dist: focal
language: ruby

env:
  - COSIGN_EXPERIMENTAL=1

services:
  - docker

keys:
  - KEYKEY # must match the key identifier set in the UI
  - KEY # must match the key identifier set in the UI


before_script:
  - echo $TRAVIS_KEYKEY > x1
  - echo $TRAVIS_KEY > x2
  - travis_key KEYKEY cosign.key
  - travis_key KEY cosign.key2
  - cat x1 |hd
  - cat x2 |hd
script:
  - echo "script started"
  - echo "${DOCKER_PASSWORD}" | docker login -u viktorijakrivokapic --password-stdin
  - docker build -t viktorijakrivokapic/hello-world-ruby .
  - docker tag viktorijakrivokapic/hello-world-ruby:latest viktorijakrivokapic/hello-world-ruby:0.0.1
  - docker push viktorijakrivokapic/hello-world-ruby:0.0.1
  - echo "docker image pushed"
  - cat cosign.key
  - cat cosign.key2
  - not_cosign --key cosign.key $(docker images --no-trunc --quiet viktorijakrivokapic/hello-world-ruby:0.0.1 | tr -d '\n')
  - cosign verify --key cosign.pub  $(docker images --no-trunc --quiet viktorijakrivokapic/hello-world-ruby:0.0.1 | tr -d '\n')
  - docker logout

